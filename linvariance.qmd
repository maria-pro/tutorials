---
title: "invariance"
format: html
editor: visual
---

## Setup 

```{r}
library(semTools)
library(haven)
library(semPlot)
library(lavaan)
library (psych)
library (psychTools)
library(tidyverse)
library (esem)

data<-read_sav("data.sav")
data<-data%>%select(-hicid)
data<-data[,1:75]
```

## ESEM fitting - all data

```{r}
main_loadings_list <- list(
  pp = c("s6_1", "s11_1", "s14_1", "s19_1", "s23_1"),
  cp = c("s5_1", "s7_1", "s12_1", "s18_1", "s22_1"),
  es = c("s3_1", "s8_1", "s13_1", "s16_1", "s24_1"),
  ha = c("s2_1","s10_1","s15_1","s21_1","s25_1"),
  ps = c("s1_1","s4_1","s9_1","s17_1","s20_1")
)

target_all<-make_target(
  data=data, 
  keys=main_loadings_list)

esem_efa_results_all<-esem_efa(
  data=data,
  nfactors = 5,
  rotate="TargetQ",
  Target= target_all)


esem_model_all <- esem_syntax(esem_efa_results, referent_list)
writeLines(esem_model_all)


```

#### CFA - all

```{r}
esem_cfa_results_all<-lavaan::cfa(model=esem_model_all,
                              data=data,
                              mimic =c("MPlus"),
                              std.lv=TRUE,
                              ordered = TRUE,
                              estimator = "WLSMV")



summary(esem_cfa_results_all, fit.measures = TRUE, standardized = TRUE, ci = TRUE)

fitmeasures(esem_cfa_results_all, c('cfi', 'rmsea', 'rmsea.ci.upper', 'bic'))


```

## Modification indices


```{r}
modificationindices(esem_cfa_results_all)%>%
   knitr::kable(caption="MI for all 3 time frames")


modificationindices(esem_cfa_results_all) %>%
  as_data_frame() %>%
  arrange(-mi) %>%
  filter(mi > 11) %>%
  select(lhs, op, rhs, mi, epc) %>%
  knitr::kable(caption="Largest MI values for esem_cfa_results_all", digits=3)
```

## Longitudinal invariance

### fitting factor by factor

```{r}

data1<-data%>%select(ends_with("_1"))
data2<-data%>%select(ends_with("_2"))
data3<-data%>%select(ends_with("_3"))


main_loadings_list <- list(
  pp = c("s6_1", "s11_1", "s14_1", "s19_1", "s23_1"),
  cp = c("s5_1", "s7_1", "s12_1", "s18_1", "s22_1"),
  es = c("s3_1", "s8_1", "s13_1", "s16_1", "s24_1"),
  ha = c("s2_1","s10_1","s15_1","s21_1","s25_1"),
  ps = c("s1_1","s4_1","s9_1","s17_1","s20_1")
)
target<-make_target(
  data=data1, 
  keys=main_loadings_list)

esem_efa_results<-esem_efa(
  data=data1,
  nfactors = 5,
  rotate="TargetQ",
  Target= target)


esem_model <- esem_syntax(esem_efa_results, referent_list)
writeLines(esem_model)

```

```{r}
#Model - factor by factor 
Model_ML1<-"
#Time1

ML11=~start(-0.10181813334364)*s1_1+
  0.341021830091293*s2_1+
  start(0.475689597452262)*s3_1+
  start(0.0448498091001827)*s4_1+
  start(0.532706326072059)*s5_1+
  start(0.380270886458239)*s6_1+
  -0.17677526014272*s7_1+
  0.557302560480769*s8_1+
  0.0154555580721658*s9_1+
  start(0.445591230767454)*s10_1+
  start(-0.14715624332716)*s11_1+
  start(0.295375297579211)*s12_1+
  0.640790531584111*s13_1+
  start(-0.283662392937637)*s14_1+
  start(0.496315161517282)*s15_1+
  start(0.456119066758138)*s16_1+
  start(-0.0300724138783131)*s17_1+
  start(0.52803060716866)*s18_1+
  start(0.545878451941098)*s19_1+
  start(0.0643676895943769)*s20_1+
  start(-0.166911003348391)*s21_1+
  start(0.218792089074707)*s22_1+
  start(0.378607161220922)*s23_1+
  start(0.45936304785388)*s24_1+
  start(-0.245500790144707)*s25_1

#Time2

ML12=~start(-0.10181813334364)*s1_2+
  0.341021830091293*s2_2+
  start(0.475689597452262)*s3_2+
  start(0.0448498091001827)*s4_2+
  start(0.532706326072059)*s5_2+
  start(0.380270886458239)*s6_2+
  -0.17677526014272*s7_2+
  0.557302560480769*s8_2+
  0.0154555580721658*s9_2+
  start(0.445591230767454)*s10_2+
  start(-0.14715624332716)*s11_2+
  start(0.295375297579211)*s12_2+
  0.640790531584111*s13_2+
  start(-0.283662392937637)*s14_2+
  start(0.496315161517282)*s15_2+
  start(0.456119066758138)*s16_2+
  start(-0.0300724138783131)*s17_2+
  start(0.52803060716866)*s18_2+
  start(0.545878451941098)*s19_2+
  start(0.0643676895943769)*s20_2+
  start(-0.166911003348391)*s21_2+
  start(0.218792089074707)*s22_2+
  start(0.378607161220922)*s23_2+
  start(0.45936304785388)*s24_2+
  start(-0.245500790144707)*s25_2

## Time3

ML13=~start(-0.10181813334364)*s1_3+
  0.341021830091293*s2_3+
  start(0.475689597452262)*s3_3+
  start(0.0448498091001827)*s4_3+
  start(0.532706326072059)*s5_3+
  start(0.380270886458239)*s6_3+
  -0.17677526014272*s7_3+
  0.557302560480769*s8_3+
  0.0154555580721658*s9_3+
  start(0.445591230767454)*s10_3+
  start(-0.14715624332716)*s11_3+
  start(0.295375297579211)*s12_3+
  0.640790531584111*s13_3+
  start(-0.283662392937637)*s14_3+
  start(0.496315161517282)*s15_3+
  start(0.456119066758138)*s16_3+
  start(-0.0300724138783131)*s17_3+
  start(0.52803060716866)*s18_3+
  start(0.545878451941098)*s19_3+
  start(0.0643676895943769)*s20_3+
  start(-0.166911003348391)*s21_3+
  start(0.218792089074707)*s22_3+
  start(0.378607161220922)*s23_3+
  start(0.45936304785388)*s24_3+
  start(-0.245500790144707)*s25_3
"


Model_ML2<-"
#Time1

ML21=~start(0.46952646970973)*s1_1+
  -0.168321479151942*s2_1+
  start(-0.0305336785896823)*s3_1+
  start(0.191527842910332)*s4_1+
  start(-0.208955192240166)*s5_1+
  start(0.00683175598992413)*s6_1+
  0.555747675045059*s7_1+
  0.106642278912651*s8_1+
  0.481947375866067*s9_1+
  start(-0.109566114954949)*s10_1+
  start(0.124527511539424)*s11_1+
  start(-0.209573540829713)*s12_1+
  -0.0361459663233181*s13_1+
  start(0.169377089517239)*s14_1+
  start(-0.342744908740705)*s15_1+
  start(-0.0619016727264182)*s16_1+
  start(0.394776044259853)*s17_1+
  start(-0.249105043255145)*s18_1+
  start(0.0445460428700227)*s19_1+
  start(0.505876999620719)*s20_1+
  start(0.514549905298726)*s21_1+
  start(-0.14936737709603)*s22_1+
  start(0.118209802834279)*s23_1+
  start(0.0809241962896773)*s24_1+
  start(0.550687205664788)*s25_1

#Time2

ML22=~start(0.46952646970973)*s1_2+
  -0.168321479151942*s2_2+
  start(-0.0305336785896823)*s3_2+
  start(0.191527842910332)*s4_2+
  start(-0.208955192240166)*s5_2+
  start(0.00683175598992413)*s6_2+
  0.555747675045059*s7_2+
  0.106642278912651*s8_2+
  0.481947375866067*s9_2+
  start(-0.109566114954949)*s10_2+
  start(0.124527511539424)*s11_2+
  start(-0.209573540829713)*s12_2+
  -0.0361459663233181*s13_2+
  start(0.169377089517239)*s14_2+
  start(-0.342744908740705)*s15_2+
  start(-0.0619016727264182)*s16_2+
  start(0.394776044259853)*s17_2+
  start(-0.249105043255145)*s18_2+
  start(0.0445460428700227)*s19_2+
  start(0.505876999620719)*s20_2+
  start(0.514549905298726)*s21_2+
  start(-0.14936737709603)*s22_2+
  start(0.118209802834279)*s23_2+
  start(0.0809241962896773)*s24_2+
  start(0.550687205664788)*s25_2

## Time3

ML23=~start(0.46952646970973)*s1_3+
  -0.168321479151942*s2_3+
  start(-0.0305336785896823)*s3_3+
  start(0.191527842910332)*s4_3+
  start(-0.208955192240166)*s5_3+
  start(0.00683175598992413)*s6_3+
  0.555747675045059*s7_3+
  0.106642278912651*s8_3+
  0.481947375866067*s9_3+
  start(-0.109566114954949)*s10_3+
  start(0.124527511539424)*s11_3+
  start(-0.209573540829713)*s12_3+
  -0.0361459663233181*s13_3+
  start(0.169377089517239)*s14_3+
  start(-0.342744908740705)*s15_3+
  start(-0.0619016727264182)*s16_3+
  start(0.394776044259853)*s17_3+
  start(-0.249105043255145)*s18_3+
  start(0.0445460428700227)*s19_3+
  start(0.505876999620719)*s20_3+
  start(0.514549905298726)*s21_3+
  start(-0.14936737709603)*s22_3+
  start(0.118209802834279)*s23_3+
  start(0.0809241962896773)*s24_3+
  start(0.550687205664788)*s25_3
"

Model_ML3<-"
#Time1

ML31=~start(0.0318685617912012)*s1_1+
  0.630374964766479*s2_1+
  start(0.0571887154094396)*s3_1+
  start(0.0538030402265071)*s4_1+
  start(0.0637918865107856)*s5_1+
  start(0.0037595073842555)*s6_1+
  -0.0295740847687255*s7_1+
  0.0144582068998616*s8_1+
  0.0306795597767665*s9_1+
  start(0.621109426134197)*s10_1+
  start(0.0769751334597619)*s11_1+
  start(0.0197092215986661)*s12_1+
  -0.0918814679617119*s13_1+
  start(0.029978222084595)*s14_1+
  start(0.312265122107737)*s15_1+
  start(0.0138061871093199)*s16_1+
  start(-0.0351187831077965)*s17_1+
  start(0.022985389287828)*s18_1+
  start(-0.0640748105499755)*s19_1+
  start(-0.0526278002086372)*s20_1+
  start(-0.126916795352038)*s21_1+
  start(0.00435500098796124)*s22_1+
  start(-0.0321217727857697)*s23_1+
  start(-0.0032698720232859)*s24_1+
  start(-0.134427464376022)*s25_1

#Time2

ML32=~start(0.0318685617912012)*s1_2+
  0.630374964766479*s2_2+
  start(0.0571887154094396)*s3_2+
  start(0.0538030402265071)*s4_2+
  start(0.0637918865107856)*s5_2+
  start(0.0037595073842555)*s6_2+
  -0.0295740847687255*s7_2+
  0.0144582068998616*s8_2+
  0.0306795597767665*s9_2+
  start(0.621109426134197)*s10_2+
  start(0.0769751334597619)*s11_2+
  start(0.0197092215986661)*s12_2+
  -0.0918814679617119*s13_2+
  start(0.029978222084595)*s14_2+
  start(0.312265122107737)*s15_2+
  start(0.0138061871093199)*s16_2+
  start(-0.0351187831077965)*s17_2+
  start(0.022985389287828)*s18_2+
  start(-0.0640748105499755)*s19_2+
  start(-0.0526278002086372)*s20_2+
  start(-0.126916795352038)*s21_2+
  start(0.00435500098796124)*s22_2+
  start(-0.0321217727857697)*s23_2+
  start(-0.0032698720232859)*s24_2+
  start(-0.134427464376022)*s25_2


## Time3

ML33=~start(0.0318685617912012)*s1_3+
  0.630374964766479*s2_3+
  start(0.0571887154094396)*s3_3+
  start(0.0538030402265071)*s4_3+
  start(0.0637918865107856)*s5_3+
  start(0.0037595073842555)*s6_3+
  -0.0295740847687255*s7_3+
  0.0144582068998616*s8_3+
  0.0306795597767665*s9_3+
  start(0.621109426134197)*s10_3+
  start(0.0769751334597619)*s11_3+
  start(0.0197092215986661)*s12_3+
  -0.0918814679617119*s13_3+
  start(0.029978222084595)*s14_3+
  start(0.312265122107737)*s15_3+
  start(0.0138061871093199)*s16_3+
  start(-0.0351187831077965)*s17_3+
  start(0.022985389287828)*s18_3+
  start(-0.0640748105499755)*s19_3+
  start(-0.0526278002086372)*s20_3+
  start(-0.126916795352038)*s21_3+
  start(0.00435500098796124)*s22_3+
  start(-0.0321217727857697)*s23_3+
  start(-0.0032698720232859)*s24_3+
  start(-0.134427464376022)*s25_3
"
Model_ML4<-"
#Time1

ML41=~start(0.117843205299031)*s1_1+
  0.00848371228260159*s2_1+
  start(0.0929136307518985)*s3_1+
  start(-0.0123382758875751)*s4_1+
  start(-0.0558123167628648)*s5_1+
  start(0.023775361078292)*s6_1+
  0.0952557898945923*s7_1+
  0.369217144239234*s8_1+
  0.0114539033227634*s9_1+
  start(-0.00371410479131914)*s10_1+
  start(-0.00729073815554198)*s11_1+
  start(-0.15945379876267)*s12_1+
  0.0209243770588006*s13_1+
  start(-0.0610717599897765)*s14_1+
  start(0.013669520843305)*s15_1+
  start(0.359777064992566)*s16_1+
  start(0.0236008838623919)*s17_1+
  start(-0.206663442278027)*s18_1+
  start(-0.138933495767261)*s19_1+
  start(-0.154035310918099)*s20_1+
  start(0.00469705937706368)*s21_1+
  start(-0.189076897903099)*s22_1+
  start(-0.0695111074225318)*s23_1+
  start(0.286447769550499)*s24_1+
  start(-0.0600228848907743)*s25_1

#Time2

ML42=~start(0.117843205299031)*s1_2+
  0.00848371228260159*s2_2+
  start(0.0929136307518985)*s3_2+
  start(-0.0123382758875751)*s4_2+
  start(-0.0558123167628648)*s5_2+
  start(0.023775361078292)*s6_2+
  0.0952557898945923*s7_2+
  0.369217144239234*s8_2+
  0.0114539033227634*s9_2+
  start(-0.00371410479131914)*s10_2+
  start(-0.00729073815554198)*s11_2+
  start(-0.15945379876267)*s12_2+
  0.0209243770588006*s13_2+
  start(-0.0610717599897765)*s14_2+
  start(0.013669520843305)*s15_2+
  start(0.359777064992566)*s16_2+
  start(0.0236008838623919)*s17_2+
  start(-0.206663442278027)*s18_2+
  start(-0.138933495767261)*s19_2+
  start(-0.154035310918099)*s20_2+
  start(0.00469705937706368)*s21_2+
  start(-0.189076897903099)*s22_2+
  start(-0.0695111074225318)*s23_2+
  start(0.286447769550499)*s24_2+
  start(-0.0600228848907743)*s25_2


## Time3

ML43=~start(0.117843205299031)*s1_3+
  0.00848371228260159*s2_3+
  start(0.0929136307518985)*s3_3+
  start(-0.0123382758875751)*s4_3+
  start(-0.0558123167628648)*s5_3+
  start(0.023775361078292)*s6_3+
  0.0952557898945923*s7_3+
  0.369217144239234*s8_3+
  0.0114539033227634*s9_3+
  start(-0.00371410479131914)*s10_3+
  start(-0.00729073815554198)*s11_3+
  start(-0.15945379876267)*s12_3+
  0.0209243770588006*s13_3+
  start(-0.0610717599897765)*s14_3+
  start(0.013669520843305)*s15_3+
  start(0.359777064992566)*s16_3+
  start(0.0236008838623919)*s17_3+
  start(-0.206663442278027)*s18_3+
  start(-0.138933495767261)*s19_3+
  start(-0.154035310918099)*s20_3+
  start(0.00469705937706368)*s21_3+
  start(-0.189076897903099)*s22_3+
  start(-0.0695111074225318)*s23_3+
  start(0.286447769550499)*s24_3+
  start(-0.0600228848907743)*s25_3

"

Model_ML5<- "
#Time1
ML51=~start(0.386993546331018)*s1_1+
 0.0209490404099033*s2_1+
 start(-0.0054433991686893)*s3_1+
 start(0.326516136546854)*s4_1+
 start(-0.0250259504849937)*s5_1+
 start(-0.27989807565512)*s6_1+
 0.0151065500711747*s7_1+
 -0.0231256595924317*s8_1+
 0.425339658015609*s9_1+
 start(0.0174598806360039)*s10_1+
 start(0.32635887160996)*s11_1+
 start(-0.0271979194024951)*s12_1+
 -0.082431747549817*s13_1+
 start(0.402026051871148)*s14_1+
 start(0.115151805310133)*s15_1+
 start(0.0441996218569334)*s16_1+
 start(0.353082490590944)*s17_1+
 start(-0.0219255651364234)*s18_1+
 start(-0.166325529041567)*s19_1+
 start(0.167267894714794)*s20_1+
 start(0.0475302921193128)*s21_1+
 start(-0.0102300226444448)*s22_1+
 start(-0.215432585452835)*s23_1+
 start(0.00968333520180835)*s24_1+
 start(-0.0288085462659386)*s25_1

#Time2

ML52=~start(0.386993546331018)*s1_2+
  0.0209490404099033*s2_2+
  start(-0.0054433991686893)*s3_2+
  start(0.326516136546854)*s4_2+
  start(-0.0250259504849937)*s5_2+
  start(-0.27989807565512)*s6_2+
  0.0151065500711747*s7_2+
  -0.0231256595924317*s8_2+
  0.425339658015609*s9_2+
  start(0.0174598806360039)*s10_2+
  start(0.32635887160996)*s11_2+
  start(-0.0271979194024951)*s12_2+
  -0.082431747549817*s13_2+
  start(0.402026051871148)*s14_2+
  start(0.115151805310133)*s15_2+
  start(0.0441996218569334)*s16_2+
  start(0.353082490590944)*s17_2+
  start(-0.0219255651364234)*s18_2+
  start(-0.166325529041567)*s19_2+
  start(0.167267894714794)*s20_2+
  start(0.0475302921193128)*s21_2+
  start(-0.0102300226444448)*s22_2+
  start(-0.215432585452835)*s23_2+
  start(0.00968333520180835)*s24_2+
  start(-0.0288085462659386)*s25_2

## Time3

ML53=~start(0.386993546331018)*s1_3+
  0.0209490404099033*s2_3+
  start(-0.0054433991686893)*s3_3+
  start(0.326516136546854)*s4_3+
  start(-0.0250259504849937)*s5_3+
  start(-0.27989807565512)*s6_3+
  0.0151065500711747*s7_3+
  -0.0231256595924317*s8_3+
  0.425339658015609*s9_3+
  start(0.0174598806360039)*s10_3+
  start(0.32635887160996)*s11_3+
  start(-0.0271979194024951)*s12_3+
  -0.082431747549817*s13_3+
  start(0.402026051871148)*s14_3+
  start(0.115151805310133)*s15_3+
  start(0.0441996218569334)*s16_3+
  start(0.353082490590944)*s17_3+
  start(-0.0219255651364234)*s18_3+
  start(-0.166325529041567)*s19_3+
  start(0.167267894714794)*s20_3+
  start(0.0475302921193128)*s21_3+
  start(-0.0102300226444448)*s22_3+
  start(-0.215432585452835)*s23_3+
  start(0.00968333520180835)*s24_3+
  start(-0.0288085462659386)*s25_3
"

var1<-c("s1_1",
        "s2_1",
        "s3_1",
        "s4_1",
        "s5_1",
        "s6_1",
        "s7_1",
        "s8_1",
        "s9_1",
        "s10_1",
        "s11_1",
        "s12_1",
        "s13_1",
        "s14_1",
        "s15_1",
        "s16_1",
        "s17_1",
        "s18_1",
        "s19_1",
        "s20_1",
        "s21_1",
        "s22_1",
        "s23_1",
        "s24_1",
        "s25_1")

var2<-c("s1_2",
        "s2_2",
        "s3_2",
        "s4_2",
        "s5_2",
        "s6_2",
        "s7_2",
        "s8_2",
        "s9_2",
        "s10_2",
        "s11_2",
        "s12_2",
        "s13_2",
        "s14_2",
        "s15_2",
        "s16_2",
        "s17_2",
        "s18_2",
        "s19_2",
        "s20_2",
        "s21_2",
        "s22_2",
        "s23_2",
        "s24_2",
        "s25_2")


var3<-c("s1_3",
        "s2_3",
        "s3_3",
        "s4_3",
        "s5_3",
        "s6_3",
        "s7_3",
        "s8_3",
        "s9_3",
        "s10_3",
        "s11_3",
        "s12_3",
        "s13_3",
        "s14_3",
        "s15_3",
        "s16_3",
        "s17_3",
        "s18_3",
        "s19_3",
        "s20_3",
        "s21_3",
        "s22_3",
        "s23_3",
        "s24_3",
        "s25_3")

constrainedVar <- list(var1, var2, var3)

ML1_inv<-longInvariance(Model_ML1, auto=1, constrainAuto=TRUE, varList=constrainedVar, data=data)

ML2_inv<-longInvariance(Model_ML2, auto=1, constrainAuto=TRUE, varList=constrainedVar, data=data)

ML3_inv<-longInvariance(Model_ML3, auto=1, constrainAuto=TRUE, varList=constrainedVar, data=data)

ML4_inv<-longInvariance(Model_ML4, auto=1, constrainAuto=TRUE, varList=constrainedVar, data=data)

ML5_inv<-longInvariance(Model_ML5, auto=1, constrainAuto=TRUE, varList=constrainedVar, data=data)
```

### ML1_inv

```{r}
ML1_inv
```

### ML2_inv

```{r}
ML2_inv
```

### ML3_inv

```{r}
ML3_inv
```

### ML4_inv

```{r}
ML4_inv
```

### ML5_inv

```{r}
ML5_inv
```
